<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fallback Behavior Validation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #2d5016; border: 1px solid #4a7c23; }
        .error { background: #5c1e1e; border: 1px solid #8b2e2e; }
        .warning { background: #5c4a1e; border: 1px solid #8b7a2e; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        #output { margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üß™ Fallback Behavior Validation Test</h1>
    <p>This test validates that the application gracefully handles backend failures with mock data.</p>
    
    <div>
        <button class="btn-primary" onclick="testNormalOperation()">Test Normal Operation</button>
        <button class="btn-danger" onclick="testFallbackBehavior()">Test Fallback Behavior</button>
        <button class="btn-primary" onclick="testTimeoutConfiguration()">Test Timeout Configuration</button>
    </div>
    
    <div id="output"></div>
    
    <script type="module">
        // Mock fetch to simulate different scenarios
        const originalFetch = window.fetch;
        let isSimulatingFailure = false;
        
        function mockNetworkFailure() {
            isSimulatingFailure = true;
            window.fetch = function(...args) {
                console.log('üö´ Mocking network failure for:', args[0]);
                return Promise.reject(new Error('Failed to fetch'));
            };
        }
        
        function restoreNormalOperation() {
            isSimulatingFailure = false;
            window.fetch = originalFetch;
        }
        
        function addResult(message, type = 'success') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            output.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        window.testNormalOperation = async function() {
            addResult('üîÑ Testing normal operation...', 'warning');
            restoreNormalOperation();
            
            try {
                // Test basic backend connectivity
                const healthResponse = await fetch('/health');
                if (healthResponse.ok) {
                    addResult('‚úÖ Backend health check passed', 'success');
                } else {
                    addResult('‚ö†Ô∏è Backend health check returned non-200 status', 'warning');
                }
                
                // Test API endpoint
                const apiResponse = await fetch('/api/v2/health');
                if (apiResponse.ok) {
                    addResult('‚úÖ API health check passed', 'success');
                } else {
                    addResult('‚ö†Ô∏è API endpoint may be using mock data', 'warning');
                }
                
            } catch (error) {
                addResult(`‚ùå Normal operation test failed: ${error.message}`, 'error');
            }
        };
        
        window.testFallbackBehavior = async function() {
            addResult('üîÑ Testing fallback behavior with simulated network failure...', 'warning');
            mockNetworkFailure();
            
            try {
                // This should fail and trigger fallback behavior
                const apiResponse = await fetch('/api/v2/players/test-player/dashboard?sport=MLB');
                addResult('‚ùå Expected failure but request succeeded - fallback may not be triggered', 'error');
            } catch (error) {
                if (error.message.includes('Failed to fetch')) {
                    addResult('‚úÖ Network failure correctly simulated and caught', 'success');
                    addResult('üìã Mock data fallback behavior should now be active in the application', 'success');
                } else {
                    addResult(`‚ö†Ô∏è Unexpected error type: ${error.message}`, 'warning');
                }
            }
            
            // Test if the application continues to work with mock data
            addResult('üìù Check the main application - it should show mock data for player information', 'warning');
            addResult('üìù Debug components should show successful prop loading with fallback data', 'warning');
        };
        
        window.testTimeoutConfiguration = async function() {
            addResult('üîÑ Testing timeout configuration...', 'warning');
            restoreNormalOperation();
            
            const startTime = Date.now();
            
            try {
                // Test with a non-existent endpoint that should timeout quickly
                await fetch('/api/v2/nonexistent-slow-endpoint', {
                    signal: AbortSignal.timeout(3000) // 3 second timeout
                });
            } catch (error) {
                const duration = Date.now() - startTime;
                
                if (duration < 5000) {
                    addResult(`‚úÖ Timeout configuration working correctly (${duration}ms < 5000ms)`, 'success');
                } else {
                    addResult(`‚ö†Ô∏è Timeout took too long (${duration}ms) - should be under 5 seconds`, 'warning');
                }
                
                if (error.name === 'AbortError' || error.message.includes('timeout')) {
                    addResult('‚úÖ Timeout error correctly detected', 'success');
                } else {
                    addResult(`‚ö†Ô∏è Unexpected error type: ${error.name} - ${error.message}`, 'warning');
                }
            }
        };
        
        // Initial setup
        addResult('üöÄ Fallback behavior validation test ready', 'success');
        addResult('üìã The backend is running and debug components show successful prop loading', 'success');
        addResult('üìã Test each button to validate different scenarios', 'warning');
    </script>
</body>
</html>
