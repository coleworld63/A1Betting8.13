<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Sport Field Fix</title>
  </head>
  <body>
    <h1>Test Sport Field Fix</h1>
    <button id="testSportField">Test Sport Field Assignment</button>
    <div id="results"></div>

    <script>
      document
        .getElementById("testSportField")
        .addEventListener("click", async () => {
          const resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = "<p>Testing sport field fix...</p>";

          try {
            // Step 1: Activate sport
            console.log("Step 1: Activating MLB sport...");
            await fetch("/api/sports/activate/MLB", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });

            // Step 2: Fetch featured props using the service
            console.log("Step 2: Testing FeaturedPropsService...");
            const response = await fetch(
              "/mlb/odds-comparison/?market_type=playerprops"
            );
            const rawData = await response.json();
            console.log("Raw backend data sample:", rawData.odds[0]);

            // Step 3: Use the enhanced data manager to map props (same as service does)
            console.log("Step 3: Testing enhanced data manager mapping...");

            // Simulate the EnhancedDataManager.fetchSportsProps logic
            const testMapProps = (props, sport) => {
              return props.map((prop) => ({
                id:
                  prop.id ||
                  prop.event_id ||
                  `${prop.player_name}-${prop.stat_type}`,
                player:
                  prop.player ||
                  prop.player_name ||
                  prop.event_name ||
                  "Unknown",
                matchup:
                  prop.matchup || prop.event_name || "Unknown vs Unknown",
                stat: prop.stat || prop.stat_type || "Unknown",
                line: parseFloat(prop.line || prop.line_score || 0),
                overOdds: parseFloat(
                  prop.overOdds || prop.over_odds || prop.value || 0
                ),
                underOdds: parseFloat(
                  prop.underOdds || prop.under_odds || prop.value || 0
                ),
                confidence: parseFloat(prop.confidence || 0),
                sport: prop.sport || sport || "Unknown", // Use passed sport context
                gameTime:
                  prop.gameTime || prop.start_time || new Date().toISOString(),
                pickType: prop.pickType || "prop",
              }));
            };

            const mappedProps = testMapProps(rawData.odds, "MLB");
            console.log("Mapped props sample:", mappedProps[0]);

            // Step 4: Test filtering logic
            const selectedSport = "MLB";
            const filtered = mappedProps.filter(
              (p) => selectedSport === "All" || p.sport === selectedSport
            );

            console.log("Filtering results:", {
              originalCount: mappedProps.length,
              selectedSport: selectedSport,
              filteredCount: filtered.length,
              sampleSports: mappedProps.slice(0, 5).map((p) => p.sport),
            });

            resultsDiv.innerHTML = `
                    <h3>✅ Sport Field Fix Test Results:</h3>
                    <p><strong>Raw backend props:</strong> ${
                      rawData.odds.length
                    }</p>
                    <p><strong>Mapped props:</strong> ${mappedProps.length}</p>
                    <p><strong>Sport field in sample prop:</strong> "${
                      mappedProps[0]?.sport
                    }"</p>
                    <p><strong>After sport filtering (${selectedSport}):</strong> ${
              filtered.length
            }</p>
                    <p><strong>Filter success:</strong> ${
                      filtered.length > 0 ? "✅ YES" : "❌ NO"
                    }</p>
                    <h4>Sample filtered prop:</h4>
                    <pre>${JSON.stringify(filtered[0], null, 2)}</pre>
                `;
          } catch (error) {
            console.error("❌ Test failed:", error);
            resultsDiv.innerHTML = `<p style="color: red;">❌ Test failed: ${error.message}</p>`;
          }
        });
    </script>
  </body>
</html>
