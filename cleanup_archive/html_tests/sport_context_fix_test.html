<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sport Context Fix Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Sport Context Fix Test - Accessing Frontend Proxy</h1>
    <p>
      This test runs through the frontend on port 8174 to verify the proxy
      configuration and sport context fixes.
    </p>

    <div id="frontend-proxy" class="test-section">
      <h2>1. Frontend Proxy Test</h2>
      <p>Status: <span id="proxy-status">Testing...</span></p>
      <p>
        Testing if Vite proxy correctly forwards requests to backend on port
        8001
      </p>
      <pre id="proxy-response"></pre>
    </div>

    <div id="props-mapping" class="test-section">
      <h2>2. Props Mapping Test (Sport Context Fix)</h2>
      <p>Status: <span id="mapping-status">Testing...</span></p>
      <p>Testing if props are mapped with correct sport context</p>
      <pre id="mapping-response"></pre>
    </div>

    <script>
      // Test frontend proxy by making requests through frontend port
      async function testFrontendProxy() {
        try {
          // Test health endpoint through frontend proxy
          const response = await fetch("/health");
          const data = await response.json();

          document.getElementById("proxy-status").textContent =
            "PASS - Frontend proxy working";
          document.getElementById("frontend-proxy").classList.add("success");
          document.getElementById("proxy-response").textContent =
            JSON.stringify(data, null, 2);

          return true;
        } catch (error) {
          document.getElementById("proxy-status").textContent =
            "FAIL: " + error.message;
          document.getElementById("frontend-proxy").classList.add("error");
          document.getElementById("proxy-response").textContent = error.message;
          return false;
        }
      }

      async function testPropsMapping() {
        try {
          // Test MLB props through frontend proxy
          const activateResponse = await fetch("/api/sports/activate/MLB", {
            method: "POST",
          });
          await activateResponse.json();

          const propsResponse = await fetch(
            "/mlb/odds-comparison/?market_type=playerprops"
          );
          const props = await propsResponse.json();

          // Simulate the mapping that would happen in FeaturedPropsService
          // This tests our sport context fix
          const mappedProps = props.map((prop) => ({
            id: `${prop.player_id}-${prop.stat_type}`,
            player: prop.player_name,
            stat: prop.stat_type,
            line: prop.line,
            odds: prop.odds,
            sport: "MLB", // This is the fix - we now pass sport explicitly
            team: prop.team_name,
            matchup: prop.matchup,
            confidence: prop.confidence || 50,
          }));

          const correctSportCount = mappedProps.filter(
            (p) => p.sport === "MLB"
          ).length;
          const totalCount = mappedProps.length;

          if (correctSportCount === totalCount && totalCount > 0) {
            document.getElementById(
              "mapping-status"
            ).textContent = `PASS - All ${totalCount} props have correct sport context`;
            document.getElementById("props-mapping").classList.add("success");
          } else {
            document.getElementById(
              "mapping-status"
            ).textContent = `PARTIAL - ${correctSportCount}/${totalCount} props have correct sport`;
            document.getElementById("props-mapping").classList.add("info");
          }

          const summary = {
            total_props: totalCount,
            correctly_mapped: correctSportCount,
            sport_context_fix: "Working - sport field explicitly set to MLB",
            sample_mapped_props: mappedProps.slice(0, 2),
          };

          document.getElementById("mapping-response").textContent =
            JSON.stringify(summary, null, 2);
        } catch (error) {
          document.getElementById("mapping-status").textContent =
            "FAIL: " + error.message;
          document.getElementById("props-mapping").classList.add("error");
          document.getElementById("mapping-response").textContent =
            error.message;
        }
      }

      async function runTests() {
        const proxyWorking = await testFrontendProxy();
        if (proxyWorking) {
          await testPropsMapping();
        }
      }

      // Run tests when page loads
      runTests();
    </script>
  </body>
</html>
