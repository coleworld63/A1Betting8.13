<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upcoming Games Props Filtering - Test Results</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(30, 41, 59, 0.8);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(59, 130, 246, 0.3);
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 25px;
        background: linear-gradient(45deg, #3b82f6, #8b5cf6);
        border-radius: 12px;
      }
      .test-section {
        background: rgba(59, 130, 246, 0.1);
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .data-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }
      .data-card {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 20px;
      }
      .code-block {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 15px;
        font-family: "Courier New", monospace;
        overflow-x: auto;
        margin: 10px 0;
        white-space: pre-wrap;
      }
      .loading {
        color: #60a5fa;
        font-style: italic;
      }
      .success {
        color: #10b981;
        font-weight: bold;
      }
      .error {
        color: #ef4444;
        font-weight: bold;
      }
      .info {
        color: #f59e0b;
        font-weight: bold;
      }
      .result-item {
        padding: 8px 12px;
        margin: 4px 0;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
        border-left: 4px solid #3b82f6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéØ Props Filtering for Upcoming Games</h1>
        <p>
          Testing that only props for players from teams with upcoming games are
          displayed
        </p>
      </div>

      <div class="test-section">
        <h2>üîç System Test Results</h2>
        <div id="testResults">
          <div class="loading">‚è≥ Running comprehensive data analysis...</div>
        </div>
      </div>

      <div class="data-grid">
        <div class="data-card">
          <h3>üìÖ Upcoming Games Data</h3>
          <div id="upcomingGamesData" class="code-block">
            <div class="loading">Loading upcoming games...</div>
          </div>
        </div>

        <div class="data-card">
          <h3>üèà Current Props Data</h3>
          <div id="propsData" class="code-block">
            <div class="loading">Loading props data...</div>
          </div>
        </div>
      </div>

      <div class="test-section">
        <h2>üéØ Filtering Analysis</h2>
        <div id="filteringAnalysis">
          <div class="loading">Analyzing filtering logic...</div>
        </div>
      </div>

      <div class="test-section">
        <h2>üìä Expected vs Actual Results</h2>
        <div id="comparisonResults">
          <div class="loading">Comparing results...</div>
        </div>
      </div>
    </div>

    <script>
      async function runComprehensiveTest() {
        const results = {
          upcomingGames: null,
          rawProps: null,
          filteredProps: null,
          analysis: {
            totalRawProps: 0,
            totalFilteredProps: 0,
            teamsWithUpcomingGames: [],
            propsFilteredOut: [],
            propsKept: [],
          },
        };

        try {
          // Step 1: Get upcoming games
          console.log("Fetching upcoming games...");
          const gamesResponse = await fetch(
            "http://127.0.0.1:8000/mlb/todays-games"
          );
          results.upcomingGames = await gamesResponse.json();

          document.getElementById("upcomingGamesData").innerHTML =
            JSON.stringify(results.upcomingGames, null, 2);

          // Extract team names
          if (results.upcomingGames.status === "ok") {
            results.analysis.teamsWithUpcomingGames =
              results.upcomingGames.games.flatMap((game) => [
                game.away_full,
                game.home_full,
                game.away,
                game.home,
              ]);
          }

          // Step 2: Get raw props data
          console.log("Fetching raw props...");
          const propsResponse = await fetch(
            "http://127.0.0.1:8000/mlb/odds-comparison/?market_type=playerprops&limit=20"
          );
          results.rawProps = await propsResponse.json();
          results.analysis.totalRawProps = results.rawProps.length;

          document.getElementById("propsData").innerHTML =
            JSON.stringify(results.rawProps.slice(0, 3), null, 2) +
            `\\n\\n... (showing first 3 of ${results.rawProps.length} total props)`;

          // Step 3: Simulate filtering logic
          const upcomingTeamNames = new Set(
            results.analysis.teamsWithUpcomingGames.map((t) => t.toLowerCase())
          );
          const today = new Date().toISOString().split("T")[0];

          results.rawProps.forEach((prop) => {
            const propTeamName = prop.team_name || "";
            const propGameStatus = prop.game_status || "";
            const propStartTime = prop.start_time || "";

            // Apply same filtering logic as frontend
            const isFinished = propGameStatus === "Final";
            const isPastDate = propStartTime && propStartTime < today;
            const isUpcomingTeam = Array.from(upcomingTeamNames).some(
              (teamName) =>
                propTeamName.toLowerCase().includes(teamName) ||
                teamName.includes(propTeamName.toLowerCase())
            );

            const shouldKeep = !isFinished && !isPastDate && isUpcomingTeam;

            if (shouldKeep) {
              results.analysis.propsKept.push({
                player: prop.player_name,
                team: prop.team_name,
                stat: prop.stat_type,
                status: prop.game_status,
                date: prop.start_time,
              });
            } else {
              results.analysis.propsFilteredOut.push({
                player: prop.player_name,
                team: prop.team_name,
                stat: prop.stat_type,
                status: prop.game_status,
                date: prop.start_time,
                reason: isFinished
                  ? "Game finished"
                  : isPastDate
                  ? "Past date"
                  : !isUpcomingTeam
                  ? "Team not in upcoming games"
                  : "Unknown",
              });
            }
          });

          results.analysis.totalFilteredProps =
            results.analysis.propsKept.length;

          // Update results display
          updateTestResults(results);
          updateFilteringAnalysis(results);
          updateComparisonResults(results);
        } catch (error) {
          console.error("Test error:", error);
          document.getElementById("testResults").innerHTML = `
            <div class="error">‚ùå Test failed: ${error.message}</div>
          `;
        }
      }

      function updateTestResults(results) {
        const testDiv = document.getElementById("testResults");
        const upcomingGamesCount = results.upcomingGames?.games?.length || 0;
        const totalTeams = results.analysis.teamsWithUpcomingGames.length;

        testDiv.innerHTML = `
          <div class="result-item">
            <span class="success">‚úÖ Upcoming Games:</span> Found ${upcomingGamesCount} games scheduled
          </div>
          <div class="result-item">
            <span class="success">‚úÖ Team Names:</span> Extracted ${totalTeams} team name variations
          </div>
          <div class="result-item">
            <span class="success">‚úÖ Raw Props:</span> Retrieved ${
              results.analysis.totalRawProps
            } player props
          </div>
          <div class="result-item">
            <span class="info">üéØ Filtering Applied:</span> ${
              results.analysis.totalFilteredProps
            } props kept, ${
          results.analysis.propsFilteredOut.length
        } filtered out
          </div>
          <div class="result-item">
            <span class="${
              results.analysis.totalFilteredProps > 0 ? "success" : "error"
            }">
              ${
                results.analysis.totalFilteredProps > 0 ? "‚úÖ" : "‚ùå"
              } Filter Result:
            </span> 
            ${
              results.analysis.totalFilteredProps > 0
                ? `Successfully showing only upcoming games props`
                : `No props match upcoming games criteria`
            }
          </div>
        `;
      }

      function updateFilteringAnalysis(results) {
        const analysisDiv = document.getElementById("filteringAnalysis");

        const reasonCounts = {};
        results.analysis.propsFilteredOut.forEach((prop) => {
          reasonCounts[prop.reason] = (reasonCounts[prop.reason] || 0) + 1;
        });

        let reasonsHtml = "";
        Object.entries(reasonCounts).forEach(([reason, count]) => {
          reasonsHtml += `<div class="result-item">üìä ${reason}: ${count} props</div>`;
        });

        analysisDiv.innerHTML = `
          <div class="result-item">
            <span class="info">üîç Filtering Breakdown:</span>
          </div>
          ${reasonsHtml}
          <div class="result-item">
            <span class="success">‚úÖ Props Kept:</span> ${
              results.analysis.totalFilteredProps
            } from upcoming games
          </div>
          <div class="code-block">
Upcoming Teams: ${JSON.stringify(
          results.analysis.teamsWithUpcomingGames,
          null,
          2
        )}
          </div>
        `;
      }

      function updateComparisonResults(results) {
        const comparisonDiv = document.getElementById("comparisonResults");

        const keptTeams = [
          ...new Set(results.analysis.propsKept.map((p) => p.team)),
        ];
        const filteredTeams = [
          ...new Set(results.analysis.propsFilteredOut.map((p) => p.team)),
        ];

        comparisonDiv.innerHTML = `
          <div class="result-item">
            <span class="success">‚úÖ Teams with Props Kept:</span> ${
              keptTeams.join(", ") || "None"
            }
          </div>
          <div class="result-item">
            <span class="error">‚ùå Teams with Props Filtered:</span> ${
              filteredTeams.join(", ") || "None"
            }
          </div>
          <div class="result-item">
            <span class="info">üìà Filtering Effectiveness:</span> 
            ${(
              (results.analysis.propsFilteredOut.length /
                results.analysis.totalRawProps) *
              100
            ).toFixed(1)}% of props filtered out
          </div>
          <div class="code-block">
Sample Kept Props:
${JSON.stringify(results.analysis.propsKept.slice(0, 3), null, 2)}

Sample Filtered Props:
${JSON.stringify(results.analysis.propsFilteredOut.slice(0, 3), null, 2)}
          </div>
        `;
      }

      // Start the test
      document.addEventListener("DOMContentLoaded", runComprehensiveTest);
    </script>
  </body>
</html>
