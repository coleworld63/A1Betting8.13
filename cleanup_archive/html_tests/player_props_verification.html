<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player Props Verification - A1Betting7-13.2</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }
      .status {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .prop-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .prop-player {
        font-weight: bold;
        color: #2563eb;
        font-size: 1.1em;
      }
      .prop-stat {
        color: #059669;
        font-weight: bold;
      }
      .prop-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .detail-item {
        background: #f8fafc;
        padding: 8px;
        border-radius: 4px;
      }
      .loading {
        text-align: center;
        color: #666;
        font-style: italic;
      }
      .error {
        background: #fee2e2;
        color: #dc2626;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #fecaca;
      }
      .success {
        background: #dcfce7;
        color: #166534;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #bbf7d0;
      }
      .summary {
        background: #eff6ff;
        border: 1px solid #dbeafe;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .filter-container {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .filter-group {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }
      select,
      input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üèÜ A1Betting7-13.2 Player Props Verification</h1>
      <p>Testing Enhanced Backend ‚Üí Frontend Data Flow</p>
    </div>

    <div id="status" class="status">
      <div class="loading">
        üîÑ Loading player props from enhanced backend...
      </div>
    </div>

    <div class="filter-container" style="display: none" id="filters">
      <h3>Filter Props:</h3>
      <div class="filter-group">
        <label
          >Player:
          <input
            type="text"
            id="playerFilter"
            placeholder="Enter player name..."
        /></label>
        <label
          >Stat Type:
          <select id="statFilter">
            <option value="">All Stats</option>
            <option value="hits">Hits</option>
            <option value="home_runs">Home Runs</option>
            <option value="strikeouts_pitcher">Strikeouts (Pitcher)</option>
            <option value="strikeouts_batter">Strikeouts (Batter)</option>
            <option value="runs_scored">Runs Scored</option>
            <option value="rbis">RBIs</option>
          </select></label
        >
        <label
          >Team:
          <select id="teamFilter">
            <option value="">All Teams</option>
          </select></label
        >
        <button onclick="applyFilters()">Apply Filters</button>
        <button onclick="clearFilters()">Clear</button>
      </div>
    </div>

    <div id="summary" class="summary" style="display: none"></div>
    <div id="propsContainer"></div>

    <script>
      let allProps = [];

      async function loadPlayerProps() {
        try {
          console.log("Fetching player props from backend...");
          const response = await fetch(
            "/mlb/odds-comparison/?market_type=playerprops"
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log("Raw response data:", data);

          if (!Array.isArray(data)) {
            throw new Error("Expected array of props, got: " + typeof data);
          }

          allProps = data;
          displaySuccess(data);
          populateFilters(data);
          displayProps(data);
        } catch (error) {
          console.error("Error loading props:", error);
          displayError(error);
        }
      }

      function displaySuccess(data) {
        const statusEl = document.getElementById("status");
        const playerProps = data.filter((prop) => prop.position !== "TEAM");
        const teamProps = data.filter((prop) => prop.position === "TEAM");

        statusEl.innerHTML = `
                <div class="success">
                    ‚úÖ <strong>Success!</strong> Enhanced backend player props are flowing correctly!
                    <br>üìä Total Props: ${data.length} | üë§ Player Props: ${playerProps.length} | üèüÔ∏è Team Props: ${teamProps.length}
                </div>
            `;

        const summaryEl = document.getElementById("summary");
        const uniquePlayers = [
          ...new Set(playerProps.map((p) => p.player_name)),
        ];
        const uniqueGames = [...new Set(data.map((p) => p.event_name))];
        const uniqueStats = [...new Set(playerProps.map((p) => p.stat_type))];

        summaryEl.innerHTML = `
                <h3>üìà Props Summary</h3>
                <div class="prop-details">
                    <div class="detail-item"><strong>Players:</strong> ${
                      uniquePlayers.length
                    }</div>
                    <div class="detail-item"><strong>Games:</strong> ${
                      uniqueGames.length
                    }</div>
                    <div class="detail-item"><strong>Stat Types:</strong> ${
                      uniqueStats.length
                    }</div>
                    <div class="detail-item"><strong>Sample Players:</strong> ${uniquePlayers
                      .slice(0, 3)
                      .join(", ")}</div>
                </div>
            `;
        summaryEl.style.display = "block";

        document.getElementById("filters").style.display = "block";
      }

      function populateFilters(data) {
        const playerProps = data.filter((prop) => prop.position !== "TEAM");
        const teams = [...new Set(playerProps.map((p) => p.team_name))].sort();

        const teamFilter = document.getElementById("teamFilter");
        teams.forEach((team) => {
          const option = document.createElement("option");
          option.value = team;
          option.textContent = team;
          teamFilter.appendChild(option);
        });
      }

      function displayError(error) {
        const statusEl = document.getElementById("status");
        statusEl.innerHTML = `
                <div class="error">
                    ‚ùå <strong>Error loading props:</strong> ${error.message}
                    <br>üìù Check that backend is running on port 8000 and frontend proxy is working.
                    <br>üîß Expected endpoint: <code>/mlb/odds-comparison/?market_type=playerprops</code>
                </div>
            `;
      }

      function displayProps(props) {
        const container = document.getElementById("propsContainer");
        const playerProps = props.filter((prop) => prop.position !== "TEAM");

        if (playerProps.length === 0) {
          container.innerHTML =
            '<div class="error">No player props found. Only team props are available.</div>';
          return;
        }

        const html = playerProps
          .slice(0, 20)
          .map(
            (prop) => `
                <div class="prop-card">
                    <div class="prop-player">${prop.player_name} (${
              prop.team_name
            })</div>
                    <div class="prop-stat">${prop.stat_type
                      .replace(/_/g, " ")
                      .toUpperCase()}: ${prop.line}</div>
                    <div class="prop-details">
                        <div class="detail-item"><strong>Game:</strong> ${
                          prop.event_name
                        }</div>
                        <div class="detail-item"><strong>Venue:</strong> ${
                          prop.venue || "N/A"
                        }</div>
                        <div class="detail-item"><strong>Position:</strong> ${
                          prop.position
                        }</div>
                        <div class="detail-item"><strong>Confidence:</strong> ${
                          prop.confidence
                        }%</div>
                        <div class="detail-item"><strong>Odds:</strong> ${
                          prop.odds > 0 ? "+" : ""
                        }${prop.odds}</div>
                        <div class="detail-item"><strong>Status:</strong> ${
                          prop.game_status
                        }</div>
                    </div>
                </div>
            `
          )
          .join("");

        container.innerHTML =
          html +
          (playerProps.length > 20
            ? `<div class="status">üìù Showing first 20 of ${playerProps.length} player props</div>`
            : "");
      }

      function applyFilters() {
        const playerFilter = document
          .getElementById("playerFilter")
          .value.toLowerCase();
        const statFilter = document.getElementById("statFilter").value;
        const teamFilter = document.getElementById("teamFilter").value;

        let filtered = allProps.filter((prop) => prop.position !== "TEAM");

        if (playerFilter) {
          filtered = filtered.filter((prop) =>
            prop.player_name.toLowerCase().includes(playerFilter)
          );
        }

        if (statFilter) {
          filtered = filtered.filter((prop) => prop.stat_type === statFilter);
        }

        if (teamFilter) {
          filtered = filtered.filter((prop) => prop.team_name === teamFilter);
        }

        displayProps(filtered);
      }

      function clearFilters() {
        document.getElementById("playerFilter").value = "";
        document.getElementById("statFilter").value = "";
        document.getElementById("teamFilter").value = "";
        displayProps(allProps);
      }

      // Load props when page loads
      window.addEventListener("load", loadPlayerProps);
    </script>
  </body>
</html>
