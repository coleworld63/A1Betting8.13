<!DOCTYPE html>
<html>
  <head>
    <title>MLB Position-Based Filtering Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
      }
      .prop-card {
        margin: 10px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 5px;
      }
      .pitcher {
        background: #e3f2fd;
      }
      .batter {
        background: #f3e5f5;
      }
      .filtered-out {
        background: #ffebee;
        text-decoration: line-through;
        opacity: 0.6;
      }
      .pass {
        color: green;
        font-weight: bold;
      }
      .fail {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>MLB Position-Based Filtering Test</h1>

    <div class="test-section">
      <h2>Test Data</h2>
      <p>
        This test uses real MLB data structure to validate position-based
        filtering logic.
      </p>
      <button onclick="runTest()">Run Position Filtering Test</button>
    </div>

    <div id="results"></div>

    <script>
      function runTest() {
        console.log("=== MLB Position-Based Filtering Test ===");

        // Test data that mirrors actual MLB API response structure
        const testProps = [
          // Position player (Right Field, position 9) with correct batter stats
          {
            id: "1",
            player: "Aaron Judge",
            stat: "hits",
            line: 1.5,
            overOdds: 150,
            underOdds: -180,
            _originalData: {
              position: "9",
              player_name: "Aaron Judge",
              stat_type: "hits",
            },
          },
          {
            id: "2",
            player: "Aaron Judge",
            stat: "home_runs",
            line: 1.5,
            overOdds: 130,
            underOdds: -150,
            _originalData: {
              position: "9",
              player_name: "Aaron Judge",
              stat_type: "home_runs",
            },
          },
          // Pitcher (position 1) with correct pitcher stats
          {
            id: "3",
            player: "Gerrit Cole",
            stat: "strikeouts",
            line: 7.5,
            overOdds: 120,
            underOdds: -140,
            _originalData: {
              position: "1",
              player_name: "Gerrit Cole",
              stat_type: "strikeouts",
            },
          },
          {
            id: "4",
            player: "Blake Snell",
            stat: "innings_pitched",
            line: 6.5,
            overOdds: 110,
            underOdds: -130,
            _originalData: {
              position: "1",
              player_name: "Blake Snell",
              stat_type: "innings_pitched",
            },
          },
          // INVALID: Position player with pitcher stat (should be filtered)
          {
            id: "5",
            player: "Mookie Betts",
            stat: "strikeouts", // This is a pitcher stat for a position player
            line: 6.5,
            overOdds: 130,
            underOdds: -150,
            _originalData: {
              position: "9", // Right field
              player_name: "Mookie Betts",
              stat_type: "strikeouts",
            },
          },
          // INVALID: Pitcher with batter stat (should be filtered)
          {
            id: "6",
            player: "Gerrit Cole",
            stat: "hits", // This is a batter stat for a pitcher
            line: 0.5,
            overOdds: 200,
            underOdds: -250,
            _originalData: {
              position: "1", // Pitcher
              player_name: "Gerrit Cole",
              stat_type: "hits",
            },
          },
          // Team totals (should always be kept)
          {
            id: "7",
            player: "Yankees Team Total",
            stat: "totals",
            line: 8.5,
            overOdds: -110,
            underOdds: -110,
            _originalData: {
              position: null,
              event_name: "Yankees vs Red Sox",
              stat_type: "totals",
            },
          },
        ];

        // Position filtering logic (exact copy from implementation)
        const pitcherStatTypes = [
          "strikeouts",
          "walks_allowed",
          "hits_allowed",
          "earned_runs",
          "innings_pitched",
          "wins",
          "saves",
          "whip",
          "era",
          "pitches_thrown",
          "first_inning_runs_allowed",
          "pitching_outs",
          "pitcher_strikeouts",
          "pitcher_walks",
          "pitcher_hits_allowed",
        ];

        const batterStatTypes = [
          "hits",
          "home_runs",
          "runs_batted_in",
          "runs_scored",
          "stolen_bases",
          "total_bases",
          "doubles",
          "triples",
          "walks",
          "strikeouts_as_batter",
          "batting_average",
          "on_base_percentage",
          "slugging_percentage",
          "singles",
          "extra_base_hits",
          "bases_on_balls",
        ];

        let results = {
          before: testProps.length,
          after: 0,
          expectedFiltered: ["1", "2", "3", "4", "7"], // IDs that should remain
          actualFiltered: [],
          details: [],
        };

        const filteredProps = testProps.filter((prop) => {
          // Skip filtering for team totals or game props
          if (
            !prop.player ||
            prop.player.toLowerCase().includes("total") ||
            prop.player.toLowerCase().includes("game") ||
            prop.stat?.toLowerCase() === "totals"
          ) {
            results.details.push({
              id: prop.id,
              player: prop.player,
              stat: prop.stat,
              kept: true,
              reason: "Team/game prop - always kept",
            });
            return true;
          }

          const statType = prop.stat?.toLowerCase() || "";
          const originalData = prop._originalData;
          const position = originalData?.position || "";

          // Check if we have position data
          if (!position) {
            results.details.push({
              id: prop.id,
              player: prop.player,
              stat: prop.stat,
              kept: true,
              reason: "No position data - kept by default",
            });
            return true;
          }

          // Position "1" indicates pitcher in baseball
          const isPitcher =
            position === "1" || position === 1 || position === "P";
          const isPitcherStat = pitcherStatTypes.some((type) =>
            statType.includes(type.toLowerCase())
          );
          const isBatterStat = batterStatTypes.some((type) =>
            statType.includes(type.toLowerCase())
          );

          let shouldKeep = true;
          let reason = "";

          if (isPitcher && isBatterStat) {
            shouldKeep = false;
            reason = `Pitcher ${prop.player} with batter stat "${statType}" - filtered out`;
          } else if (!isPitcher && isPitcherStat) {
            shouldKeep = false;
            reason = `Position player ${prop.player} (pos: ${position}) with pitcher stat "${statType}" - filtered out`;
          } else {
            reason = `${isPitcher ? "Pitcher" : "Position player"} ${
              prop.player
            } with appropriate stat "${statType}" - kept`;
          }

          results.details.push({
            id: prop.id,
            player: prop.player,
            stat: prop.stat,
            position: position,
            isPitcher: isPitcher,
            isPitcherStat: isPitcherStat,
            isBatterStat: isBatterStat,
            kept: shouldKeep,
            reason: reason,
          });

          return shouldKeep;
        });

        results.after = filteredProps.length;
        results.actualFiltered = filteredProps.map((p) => p.id);

        // Test validation
        const expectedSet = new Set(results.expectedFiltered);
        const actualSet = new Set(results.actualFiltered);
        const testPassed =
          results.expectedFiltered.length === results.actualFiltered.length &&
          results.expectedFiltered.every((id) => actualSet.has(id));

        // Display results
        const resultsHtml = `
                <div class="test-section">
                    <h2>Test Results</h2>
                    <p class="${testPassed ? "pass" : "fail"}">
                        Test ${testPassed ? "PASSED ✅" : "FAILED ❌"}
                    </p>
                    <p><strong>Props before filtering:</strong> ${
                      results.before
                    }</p>
                    <p><strong>Props after filtering:</strong> ${
                      results.after
                    }</p>
                    <p><strong>Expected IDs:</strong> [${results.expectedFiltered.join(
                      ", "
                    )}]</p>
                    <p><strong>Actual IDs:</strong> [${results.actualFiltered.join(
                      ", "
                    )}]</p>
                </div>

                <div class="test-section">
                    <h2>Detailed Results</h2>
                    ${results.details
                      .map(
                        (detail) => `
                        <div class="prop-card ${
                          detail.kept
                            ? detail.isPitcher
                              ? "pitcher"
                              : "batter"
                            : "filtered-out"
                        }">
                            <strong>ID ${detail.id}: ${detail.player} - ${
                          detail.stat
                        }</strong>
                            <br>Position: ${detail.position || "N/A"} 
                            ${
                              detail.position === "1"
                                ? "(Pitcher)"
                                : detail.position
                                ? "(Position Player)"
                                : ""
                            }
                            <br>Result: ${detail.kept ? "KEPT" : "FILTERED OUT"}
                            <br>Reason: ${detail.reason}
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;

        document.getElementById("results").innerHTML = resultsHtml;

        console.log("Test completed:", testPassed ? "PASSED" : "FAILED");
        console.log("Details:", results);
      }
    </script>
  </body>
</html>
