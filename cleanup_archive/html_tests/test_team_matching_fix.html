<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Team Matching Fix</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        border: 1px solid #ccc;
        margin: 10px 0;
        padding: 15px;
      }
      .pass {
        color: green;
        font-weight: bold;
      }
      .fail {
        color: red;
        font-weight: bold;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Test: Team Matching Logic Fix</h1>

    <div class="test-section">
      <h2>Testing Enhanced Team Normalization</h2>
      <div id="team-normalization-results"></div>
    </div>

    <div class="test-section">
      <h2>Testing Prop Filtering for Selected Games</h2>
      <div id="prop-filtering-results"></div>
    </div>

    <div class="test-section">
      <h2>Real API Test</h2>
      <button onclick="testRealApi()">Test with Real Backend Data</button>
      <div id="real-api-results"></div>
    </div>

    <script>
      // Enhanced team normalization function (copied from the fix)
      function normalizeTeamName(teamName) {
        const name = teamName.toLowerCase().trim();
        const teamMappings = {
          // American League East
          "blue jays": ["tor", "toronto", "jays", "toronto blue jays"],
          orioles: ["bal", "baltimore", "baltimore orioles"],
          "red sox": ["bos", "boston", "sox", "boston red sox"],
          rays: ["tb", "tampa bay", "tampa bay rays", "tampa"],
          yankees: ["nyy", "new york yankees", "ny yankees", "yankees"],

          // American League Central
          "white sox": ["cws", "chicago", "chicago white sox", "chw"],
          guardians: ["cle", "cleveland", "cleveland guardians"],
          tigers: ["det", "detroit", "detroit tigers"],
          royals: ["kc", "kansas city", "kansas city royals"],
          twins: ["min", "minnesota", "minnesota twins"],

          // American League West
          astros: ["hou", "houston", "houston astros"],
          angels: ["laa", "los angeles angels", "anaheim", "la angels"],
          athletics: ["oak", "oakland", "oakland athletics", "as"],
          mariners: ["sea", "seattle", "seattle mariners"],
          rangers: ["tex", "texas", "texas rangers"],

          // National League East
          braves: ["atl", "atlanta", "atlanta braves"],
          marlins: ["mia", "miami", "miami marlins", "florida"],
          mets: ["nym", "new york mets", "ny mets"],
          phillies: ["phi", "philadelphia", "philadelphia phillies"],
          nationals: ["wsh", "washington", "washington nationals"],

          // National League Central
          cubs: ["chc", "chicago cubs", "chicago", "chi cubs"],
          reds: ["cin", "cincinnati", "cincinnati reds"],
          brewers: ["mil", "milwaukee", "milwaukee brewers"],
          pirates: ["pit", "pittsburgh", "pittsburgh pirates"],
          cardinals: ["stl", "st louis", "st. louis", "st louis cardinals"],

          // National League West
          diamondbacks: ["ari", "arizona", "arizona diamondbacks", "dbacks"],
          rockies: ["col", "colorado", "colorado rockies"],
          dodgers: ["lad", "los angeles dodgers", "la dodgers"],
          padres: ["sd", "san diego", "san diego padres"],
          giants: ["sf", "san francisco", "san francisco giants"],
        };

        // Find canonical team name by checking all variants
        for (const [canonical, variants] of Object.entries(teamMappings)) {
          if (variants.includes(name) || name.includes(canonical)) {
            return canonical;
          }
        }
        return name;
      }

      // Test the normalization logic
      function testTeamNormalization() {
        const testCases = [
          // Test cases based on the real data we saw
          { input: "Giants", expected: "giants" },
          { input: "PIT", expected: "pirates" },
          { input: "Pirates", expected: "pirates" },
          { input: "San Francisco Giants", expected: "giants" },
          { input: "SF", expected: "giants" },
          { input: "Pittsburgh Pirates", expected: "pirates" },
          { input: "Orioles", expected: "orioles" },
          { input: "BAL", expected: "orioles" },
          { input: "Baltimore Orioles", expected: "orioles" },
        ];

        let results = "<h3>Team Normalization Test Results:</h3>";
        let passed = 0;
        let total = testCases.length;

        testCases.forEach((test) => {
          const result = normalizeTeamName(test.input);
          const isPass = result === test.expected;
          if (isPass) passed++;

          results += `<div class="${isPass ? "pass" : "fail"}">
                    "${test.input}" -> "${result}" ${
            isPass ? "✅" : `❌ (expected "${test.expected}")`
          }
                </div>`;
        });

        results += `<p><strong>Results: ${passed}/${total} passed</strong></p>`;
        document.getElementById("team-normalization-results").innerHTML =
          results;
      }

      // Test prop filtering logic
      function testPropFiltering() {
        // Simulate data from backend
        const selectedGame = {
          away: "Giants",
          home: "Pirates",
          event_name: "San Francisco Giants @ Pittsburgh Pirates",
        };

        const sampleProps = [
          {
            player: "Oneil Cruz",
            _originalData: {
              team_name: "PIT",
              event_name: "San Francisco Giants @ Pittsburgh Pirates",
            },
            matchup: "San Francisco Giants @ Pittsburgh Pirates",
          },
          {
            player: "Mike Yastrzemski",
            _originalData: {
              team_name: "SF",
              event_name: "San Francisco Giants @ Pittsburgh Pirates",
            },
            matchup: "San Francisco Giants @ Pittsburgh Pirates",
          },
          {
            player: "Ronald Acuna Jr",
            _originalData: {
              team_name: "ATL",
              event_name: "Atlanta Braves @ Philadelphia Phillies",
            },
            matchup: "Atlanta Braves @ Philadelphia Phillies",
          },
        ];

        const selectedAwayNorm = normalizeTeamName(selectedGame.away);
        const selectedHomeNorm = normalizeTeamName(selectedGame.home);

        let results = "<h3>Prop Filtering Test Results:</h3>";
        results += `<p>Selected Game: ${selectedGame.event_name}</p>`;
        results += `<p>Normalized Teams: away="${selectedAwayNorm}", home="${selectedHomeNorm}"</p>`;

        const matchedProps = sampleProps.filter((proj) => {
          // Test exact event_name match
          const propEventName = proj._originalData?.event_name;
          if (propEventName && propEventName === selectedGame.event_name) {
            return true;
          }

          // Test team_name matching
          const propTeamName = proj._originalData?.team_name;
          if (propTeamName) {
            const propTeamNorm = normalizeTeamName(propTeamName);
            if (
              propTeamNorm === selectedAwayNorm ||
              propTeamNorm === selectedHomeNorm
            ) {
              return true;
            }
          }

          return false;
        });

        results += `<h4>Filtering Results:</h4>`;
        results += `<p>Input Props: ${sampleProps.length}, Matched Props: ${matchedProps.length}</p>`;

        sampleProps.forEach((prop) => {
          const propTeamName = prop._originalData?.team_name;
          const propTeamNorm = normalizeTeamName(propTeamName || "");
          const isMatched = matchedProps.includes(prop);

          results += `<div class="${isMatched ? "pass" : "fail"}">
                    ${prop.player} (${propTeamName} -> ${propTeamNorm}) ${
            isMatched ? "✅ MATCHED" : "❌ filtered out"
          }
                </div>`;
        });

        document.getElementById("prop-filtering-results").innerHTML = results;
      }

      // Test with real backend data
      async function testRealApi() {
        const resultsDiv = document.getElementById("real-api-results");
        resultsDiv.innerHTML = "<p>Testing with real backend data...</p>";

        try {
          // Fetch real data from backend
          const [gamesResponse, propsResponse] = await Promise.all([
            fetch("http://localhost:8000/mlb/todays-games"),
            fetch(
              "http://localhost:8000/mlb/odds-comparison/?market_type=playerprops&limit=50"
            ),
          ]);

          if (!gamesResponse.ok || !propsResponse.ok) {
            throw new Error("Backend requests failed");
          }

          const gamesData = await gamesResponse.json();
          const propsData = await propsResponse.json();

          if (!gamesData.games || !Array.isArray(propsData)) {
            throw new Error("Invalid data format from backend");
          }

          // Test filtering with first game
          const firstGame = gamesData.games[0];
          const selectedAwayNorm = normalizeTeamName(firstGame.away);
          const selectedHomeNorm = normalizeTeamName(firstGame.home);

          const matchedProps = propsData.filter((prop) => {
            // Test exact event_name match
            if (prop.event_name === firstGame.event_name) {
              return true;
            }

            // Test team_name matching
            if (prop.team_name) {
              const propTeamNorm = normalizeTeamName(prop.team_name);
              return (
                propTeamNorm === selectedAwayNorm ||
                propTeamNorm === selectedHomeNorm
              );
            }

            return false;
          });

          let results = "<h3>Real Backend Test Results:</h3>";
          results += `<p><strong>Selected Game:</strong> ${firstGame.event_name}</p>`;
          results += `<p><strong>Game Teams:</strong> ${firstGame.away} (${selectedAwayNorm}) @ ${firstGame.home} (${selectedHomeNorm})</p>`;
          results += `<p><strong>Total Props:</strong> ${propsData.length}</p>`;
          results += `<p><strong>Matched Props:</strong> ${matchedProps.length}</p>`;

          if (matchedProps.length > 0) {
            results +=
              '<div class="pass">✅ SUCCESS: Props found for selected game!</div>';
            results += "<h4>Sample Matched Props:</h4>";
            results +=
              "<pre>" +
              JSON.stringify(
                matchedProps.slice(0, 3).map((p) => ({
                  player: p.player_name,
                  team: p.team_name,
                  stat: p.stat_type,
                  event: p.event_name,
                })),
                null,
                2
              ) +
              "</pre>";
          } else {
            results +=
              '<div class="fail">❌ ISSUE: No props found for selected game</div>';
            results += "<h4>Sample Available Props:</h4>";
            results +=
              "<pre>" +
              JSON.stringify(
                propsData.slice(0, 3).map((p) => ({
                  player: p.player_name,
                  team: p.team_name,
                  stat: p.stat_type,
                  event: p.event_name,
                })),
                null,
                2
              ) +
              "</pre>";
          }

          resultsDiv.innerHTML = results;
        } catch (error) {
          resultsDiv.innerHTML = `<div class="fail">❌ Error: ${error.message}</div>`;
        }
      }

      // Run tests on page load
      window.onload = function () {
        testTeamNormalization();
        testPropFiltering();
      };
    </script>
  </body>
</html>
