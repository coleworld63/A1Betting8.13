<!DOCTYPE html>
<html>
  <head>
    <title>FeaturedPropsService Fix Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 10px 0;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>FeaturedPropsService Fix Verification</h1>

    <div class="test-section">
      <h2>Test: Fetch and Map MLB Props</h2>
      <button onclick="testFeaturedPropsMapping()">
        Test Featured Props Mapping
      </button>
      <div id="mapping-result"></div>
    </div>

    <script>
      async function testFeaturedPropsMapping() {
        const resultDiv = document.getElementById("mapping-result");
        resultDiv.innerHTML =
          "<p>Testing FeaturedPropsService mapping logic...</p>";

        try {
          // Step 1: Fetch from backend (simulating FeaturedPropsService)
          const res = await fetch("http://localhost:8000/mlb/odds-comparison/");
          const responseData = await res.json();

          // Step 2: Extract data array (with the fix)
          let arr = [];
          if (Array.isArray(responseData)) {
            arr = responseData;
          } else if (Array.isArray(responseData?.odds)) {
            arr = responseData.odds; // This is the fix!
          } else if (Array.isArray(responseData?.data)) {
            arr = responseData.data;
          }

          if (arr.length === 0) {
            resultDiv.innerHTML =
              '<p class="error">❌ No data found in response</p>';
            return;
          }

          // Step 3: Simulate the grouping and mapping logic
          const norm = (v) =>
            typeof v === "string" ? v.trim().toLowerCase() : v;
          const totalsMap = new Map();
          const nonTotals = [];

          for (const item of arr) {
            if (norm(item.stat_type) === "totals") {
              const key = [
                item.event_id,
                item.stat_type,
                item.line_score ?? item.line ?? 0,
              ].join("|");
              if (!totalsMap.has(key)) {
                totalsMap.set(key, {
                  event_id: item.event_id,
                  provider_id: item.provider_id,
                  stat_type: item.stat_type,
                  event_name: item.event_name,
                  matchup: item.matchup,
                  team_name: item.team_name,
                  line: item.line_score ?? item.line ?? 0,
                  start_time: item.start_time,
                  overOdds: 0,
                  underOdds: 0,
                  confidence: item.confidence || 0,
                });
              }
              const group = totalsMap.get(key);
              if (norm(item.team_name) === "over") {
                group.overOdds = item.value || 0;
              }
              if (norm(item.team_name) === "under") {
                group.underOdds = item.value || 0;
              }
            } else {
              nonTotals.push(item);
            }
          }

          // Step 4: Map totals
          const mappedTotals = Array.from(totalsMap.values()).map((item) => {
            let displayPlayer =
              item.event_name || item.matchup || "Total (Game)";
            const matchup = item.event_name || item.matchup || "N/A";

            return {
              id: [
                item.event_id,
                item.provider_id,
                item.stat_type,
                displayPlayer,
              ]
                .filter(Boolean)
                .join("-"),
              player: displayPlayer,
              matchup,
              stat: "Total Runs",
              line: item.line,
              overOdds: item.overOdds,
              underOdds: item.underOdds,
              confidence: item.confidence,
              sport: "MLB",
              gameTime: item.start_time || "",
              pickType: "Total Runs",
            };
          });

          // Step 5: Map non-totals (simplified)
          const mappedNonTotals = nonTotals.slice(0, 10).map((item) => {
            let player = item.player_name || item.team_name || "N/A";
            if (
              item.team_name &&
              !["over", "under"].includes(norm(item.team_name))
            ) {
              player = `${item.team_name} (Team)`;
            }

            return {
              id: [item.event_id, item.provider_id, item.stat_type, player]
                .filter(Boolean)
                .join("-"),
              player: player,
              matchup: item.event_name || item.matchup || "N/A",
              stat:
                item.stat_type === "spreads"
                  ? "Point Spread"
                  : item.stat_type === "h2h"
                  ? "Moneyline"
                  : item.stat_type,
              line: item.line_score ?? item.line ?? 0,
              overOdds: item.value || 0,
              underOdds: 0,
              confidence: item.confidence || 0,
              sport: "MLB",
              gameTime: item.start_time || "",
              pickType: item.stat_type,
            };
          });

          const allMapped = [...mappedTotals, ...mappedNonTotals];

          // Step 6: Display results
          resultDiv.innerHTML = `
                    <p class="success">✅ SUCCESS! FeaturedPropsService mapping now works!</p>
                    <p><strong>Raw data:</strong> ${
                      arr.length
                    } items from backend</p>
                    <p><strong>Mapped totals:</strong> ${
                      mappedTotals.length
                    } props</p>
                    <p><strong>Mapped non-totals (sample):</strong> ${
                      mappedNonTotals.length
                    } props</p>
                    <p><strong>Total mapped props:</strong> ${
                      allMapped.length
                    } props</p>
                    <p class="success"><strong>This means props will now display in the frontend!</strong></p>
                    <details>
                        <summary>Sample mapped props (click to expand)</summary>
                        <pre>${JSON.stringify(
                          allMapped.slice(0, 5),
                          null,
                          2
                        )}</pre>
                    </details>
                `;
        } catch (error) {
          resultDiv.innerHTML = `<p class="error">❌ Test failed: ${error.message}</p>`;
        }
      }

      // Auto-run the test
      window.onload = function () {
        setTimeout(testFeaturedPropsMapping, 500);
      };
    </script>
  </body>
</html>
