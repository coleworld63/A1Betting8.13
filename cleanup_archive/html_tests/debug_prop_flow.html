<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Prop Flow</title>
  </head>
  <body>
    <h1>Debug Prop Flow Test</h1>
    <button id="testFlow">Test Complete Prop Flow</button>
    <div id="results"></div>

    <script>
      document
        .getElementById("testFlow")
        .addEventListener("click", async () => {
          const resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = "<p>Testing complete prop flow...</p>";

          try {
            // Step 1: Activate sport
            console.log("Step 1: Activating MLB sport...");
            const activationResponse = await fetch("/api/sports/activate/MLB", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });

            if (!activationResponse.ok) {
              throw new Error(
                `Activation failed: ${activationResponse.status}`
              );
            }

            console.log("✅ Sport activated successfully");

            // Step 2: Fetch featured props
            console.log("Step 2: Fetching featured props...");
            const propsResponse = await fetch("/api/mlb/featured-props");

            if (!propsResponse.ok) {
              throw new Error(`Props fetch failed: ${propsResponse.status}`);
            }

            const candidateProps = await propsResponse.json();
            console.log(
              "✅ Featured props fetched:",
              candidateProps.length,
              "props"
            );
            console.log("Sample prop:", candidateProps[0]);

            // Step 3: Test batch predictions
            console.log("Step 3: Testing batch predictions...");
            const batchResponse = await fetch("/api/mlb/batch-predictions", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                props: candidateProps.slice(0, 10), // Test with first 10 props
              }),
            });

            if (!batchResponse.ok) {
              throw new Error(
                `Batch predictions failed: ${batchResponse.status}`
              );
            }

            const batchResults = await batchResponse.json();
            console.log(
              "✅ Batch predictions completed:",
              batchResults.length,
              "results"
            );
            console.log("Sample enhanced prop:", batchResults[0]);

            // Step 4: Test filtering and consolidation logic
            console.log("Step 4: Testing filtering and consolidation...");

            // Simulate the filtering logic from PropOllamaUnified
            const selectedSport = "MLB";
            const searchTerm = "";

            // Filter by sport
            const sportFiltered = batchResults.filter(
              (p) => selectedSport === "All" || p.sport === selectedSport
            );
            console.log("After sport filtering:", sportFiltered.length);

            // Filter by search term (empty = all pass)
            const searchFiltered = sportFiltered.filter(
              (p) =>
                searchTerm === "" ||
                (p.player &&
                  p.player.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (p.matchup &&
                  p.matchup.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            console.log("After search filtering:", searchFiltered.length);

            // Sort by confidence (highest first)
            const sorted = searchFiltered.sort(
              (a, b) => b.confidence - a.confidence
            );
            console.log("After sorting:", sorted.length);
            console.log(
              "Top 3 by confidence:",
              sorted.slice(0, 3).map((p) => ({
                player: p.player,
                stat: p.stat,
                confidence: p.confidence,
              }))
            );

            // Test consolidation logic
            const playerMap = new Map();
            sorted.forEach((proj) => {
              const playerKey = `${proj.player}-${proj.matchup}`;
              console.log("Processing for consolidation:", {
                player: proj.player,
                matchup: proj.matchup,
                playerKey: playerKey,
              });

              if (playerMap.has(playerKey)) {
                const existingProj = playerMap.get(playerKey);
                if (!existingProj.alternativeProps) {
                  existingProj.alternativeProps = [];
                }
                existingProj.alternativeProps.push({
                  stat: proj.stat || "Unknown",
                  line: proj.line || 0,
                  confidence: proj.confidence || 0,
                });
                console.log("Added as alternative prop for:", playerKey);
              } else {
                playerMap.set(playerKey, {
                  ...proj,
                  alternativeProps: [],
                });
                console.log("Created new player card for:", playerKey);
              }
            });

            const consolidated = Array.from(playerMap.values());
            console.log("After consolidation:", consolidated.length);

            // Test final visible calculation
            const visiblePropsCount = 6;
            const visible = consolidated.slice(0, visiblePropsCount);
            console.log("Final visible projections:", visible.length);

            resultsDiv.innerHTML = `
                    <h3>✅ Complete Flow Test Results:</h3>
                    <p><strong>Original props:</strong> ${
                      candidateProps.length
                    }</p>
                    <p><strong>Enhanced props:</strong> ${
                      batchResults.length
                    }</p>
                    <p><strong>Sport filtered:</strong> ${
                      sportFiltered.length
                    }</p>
                    <p><strong>Search filtered:</strong> ${
                      searchFiltered.length
                    }</p>
                    <p><strong>After consolidation:</strong> ${
                      consolidated.length
                    }</p>
                    <p><strong>Visible projections:</strong> ${
                      visible.length
                    }</p>
                    <h4>Sample visible projection:</h4>
                    <pre>${JSON.stringify(visible[0], null, 2)}</pre>
                `;
          } catch (error) {
            console.error("❌ Test failed:", error);
            resultsDiv.innerHTML = `<p style="color: red;">❌ Test failed: ${error.message}</p>`;
          }
        });
    </script>
  </body>
</html>
